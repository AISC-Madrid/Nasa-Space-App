<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cloud2Action Health - Air Quality Map</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/728/728093.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      height: 100vh;
      overflow: hidden;
      font-family: "Inter", system-ui, sans-serif;
      background-color: #f4f6f9;
    }

    nav.navbar {
      background: linear-gradient(90deg, #007bff, #00bcd4);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }
    nav.navbar .navbar-brand {
      color: white;
      font-weight: 700;
      letter-spacing: 0.7px;
    }

    #map {
      height: calc(100vh - 56px);
      width: 100%;
    }

    .info-panel {
      height: calc(100vh - 56px);
      overflow-y: auto;
      background: #ffffff;
      border-left: none;
      padding: 2rem;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.6s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .info-panel h2 {
      font-size: 1.7rem;
      margin-bottom: 1rem;
      background: linear-gradient(90deg, #007bff, #00bcd4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    .aqi-box {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      transition: 0.3s;
    }

    .aqi-box:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .aqi-value {
      font-size: 3rem;
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .alert-aqi {
      font-weight: 600;
      padding: 0.4em 0.8em;
      border-radius: 0.5rem;
      display: inline-block;
      color: white;
      margin-top: 0.3rem;
    }

    .GOOD { background-color: #28a745; }
    .MODERATE { background-color: #ffc107; color: #212529; }
    .UNHEALTHYFORSS { background-color: #fd7e14; }
    .UNHEALTHY { background-color: #dc3545; }
    .VERYUNHEALTHY { background-color: #6f42c1; }
    .HAZARDOUS { background-color: #343a40; }

    .pollutant-card {
      background: #f8f9fa;
      border-radius: 0.8rem;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 0.75rem;
      transition: 0.25s;
    }

    .pollutant-card:hover {
      transform: translateY(-2px);
      background: #eef3f9;
    }

    .pollutant-title {
      font-weight: 600;
      color: #0d6efd;
    }

    .pollutant-value {
      font-weight: 700;
      color: #212529;
    }

    footer {
      text-align: center;
      font-size: 0.85rem;
      color: #888;
      padding: 0.75rem;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark px-4">
    <a class="navbar-brand" href="#">‚òÅÔ∏è cloud2action.health</a>
  </nav>

  <!-- Main container -->
  <div class="container-fluid px-0">
    <div class="row g-0">

      <!-- Map -->
      <div class="col-md-8">
        <div id="map"></div>
      </div>

      <!-- Info Panel -->
      <div class="col-md-4 info-panel d-flex flex-column justify-content-between">
        <div>
          <div class="aqi-box mb-4">
            <h2>Air Quality Index</h2>
            <p class="aqi-value text-primary" id="aqi">--</p>
            <p id="aqi-alert" class="alert-aqi bg-secondary">Waiting for data...</p>
            <p class="text-muted mt-2">Tap on the map or use your location</p>
          </div>

          <div>
            <h5 class="mb-3 text-primary fw-bold">Pollutant Components</h5>
            <div id="components"></div>
          </div>
        </div>

        <footer>
          &copy; 2025 <strong>Cloud2Action Health</strong> ‚Äì Environmental Insights Dashboard
        </footer>
      </div>

    </div>
  </div>

  <!-- JS -->
  <script>
    const map = L.map('map').fitWorld();
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 3,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // üåç Base Map

// üå´Ô∏è NASA GIBS WMS Layers
const wmsLayers = {
  "Nitrogen Dioxide": L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
    layers: "SMAP_L4_Mean_Net_Ecosystem_Exchange",
    format: "image/png",
    transparent: true,
    version: "1.1.1",
    attribution: "NASA GIBS"
  }),

  "Ozone": L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
    layers: "TEMPO_L3_Ozone_Column_Amount",
    format: "image/png",
    transparent: true,
    version: "1.1.1",
    attribution: "NASA GIBS"
  }),

  "Particulate Matter": L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
    layers: "MODIS_Aqua_Aerosol_Optical_Depth_3km",
    format: "image/png",
    transparent: true,
    version: "1.1.1",
    attribution: "NASA GIBS"
  }),

  "Radiation": L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
    layers: "AIRS_L3_All_Sky_Outgoing_Longwave_Radiation_Daily_Day",
    format: "image/png",
    transparent: true,
    version: "1.1.1",
    attribution: "NASA GIBS"
  })
};

// ‚úÖ Default visible layer
wmsLayers["Nitrogen Dioxide"].addTo(map);

// üß≠ Add Layer Control (base map + overlays)
L.control.layers(
  { "OpenStreetMap": baseLayer },
  {
    "Nitrogen Dioxide (NO‚ÇÇ)": wmsLayers["Nitrogen Dioxide"],
    "Ozone (O‚ÇÉ)": wmsLayers["Ozone"],
    "Particulate Matter (PM‚ÇÇ.‚ÇÖ)": wmsLayers["Particulate Matter"],
    "Radiation": wmsLayers["Radiation"]
  }
).addTo(map);


    map.locate({setView: true, maxZoom: 6});
    map.on('locationfound', e => {
      const marker = L.marker(e.latlng).addTo(map).bindPopup('You are here').openPopup();
      fetchAirQuality(e.latlng.lat, e.latlng.lng);
    });

    map.on('click', e => {
      map.closePopup();
      const marker = L.marker(e.latlng).addTo(map).bindPopup('Fetching air quality...').openPopup();
      fetchAirQuality(e.latlng.lat, e.latlng.lng);
    });

    function fetchAirQuality(lat, lon) {
      fetch(`/api/air_quality?lat=${lat}&lon=${lon}`)
        .then(res => res.json())
        .then(data => {
          const aqiValue = document.getElementById("aqi");
          const alertBox = document.getElementById("aqi-alert");
          const list = document.getElementById("components");

          const percentage = data.pollution_percentage;
          aqiValue.textContent = percentage ? percentage.toFixed(1) + "%" : "--";

          // Determine AQI alert
          const riskLevels = [
            {max: 50, class: "GOOD", text: "Good ‚Äì Air quality is satisfactory"},
            {max: 100, class: "MODERATE", text: "Moderate ‚Äì Acceptable for most"},
            {max: 150, class: "UNHEALTHYFORSS", text: "Unhealthy for Sensitive Groups"},
            {max: 200, class: "UNHEALTHY", text: "Unhealthy ‚Äì May affect everyone"},
            {max: 300, class: "VERYUNHEALTHY", text: "Very Unhealthy"},
            {max: 999, class: "HAZARDOUS", text: "Hazardous ‚Äì Avoid outdoor activity"}
          ];

          const level = riskLevels.find(l => percentage <= l.max) || riskLevels[5];
          alertBox.className = `alert-aqi ${level.class}`;
          alertBox.textContent = level.text;

          list.innerHTML = "";
          for (const [param, info] of Object.entries(data.latest_values || {})) {
            const div = document.createElement("div");
            div.className = "pollutant-card";
            div.innerHTML = `
              <div class="d-flex justify-content-between">
                <span class="pollutant-title">${param.toUpperCase()}</span>
                <span class="pollutant-value">${info.value ?? "--"}</span>
              </div>
              ${info.risk ? `<div class="mt-2"><span class="risk-badge ${info.risk.replace(/ /g,'').toUpperCase()}">${info.risk}</span></div>` : ""}
            `;
            list.appendChild(div);
          }
        })
        .catch(err => {
          console.error("Error fetching air quality:", err);
          document.getElementById("aqi").textContent = "--";
          document.getElementById("aqi-alert").textContent = "Error retrieving data";
          document.getElementById("aqi-alert").className = "alert-aqi bg-dark";
          document.getElementById("components").innerHTML = "";
        });
    }
  </script>

</body>
</html>
